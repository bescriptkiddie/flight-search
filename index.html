<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æµ·èˆª666éšå¿ƒé£ - èˆªçº¿è§„åˆ’å™¨</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ä½¿ç”¨Unicodeå›¾æ ‡æ›¿ä»£é˜¿é‡Œå›¾æ ‡åº“ -->
    <style>
      .icon-airplane::before {
        content: "âœˆï¸";
      }
      .icon-search::before {
        content: "ğŸ”";
      }
      .icon-close::before {
        content: "âœ–ï¸";
      }
      .icon-filter::before {
        content: "ğŸ”½";
      }
      .icon-arrow-down::before {
        content: "â¬‡ï¸";
      }
      .icon-tips::before {
        content: "ğŸ’¡";
      }
      .icon-departure::before {
        content: "ğŸ›«";
      }
      .icon-arrival::before {
        content: "ğŸ›¬";
      }
      .icon-location::before {
        content: "ğŸ“";
      }
      .icon-flight-number::before {
        content: "ğŸ”¢";
      }
      .icon-product::before {
        content: "ğŸ“¦";
      }
      .icon-time::before {
        content: "â°";
      }
      .icon-clock::before {
        content: "ğŸ•";
      }
      .icon-calendar::before {
        content: "ğŸ“…";
      }
      .icon-empty::before {
        content: "ğŸ“­";
      }
      .icon-moon::before {
        content: "ğŸŒ™";
      }
      .icon-sun::before {
        content: "â˜€ï¸";
      }
      .icon-export::before {
        content: "ğŸ“¤";
      }
      .icon-reset::before {
        content: "ğŸ”„";
      }
      .icon-apply::before {
        content: "âœ…";
      }
      .icon-status::before {
        content: "ğŸŸ¢";
      }
      .icon-available::before {
        content: "âœ…";
      }
      .icon-unavailable::before {
        content: "âŒ";
      }
      .icon-early::before {
        content: "ğŸŒ…";
      }
      .icon-morning::before {
        content: "ğŸŒ¤ï¸";
      }
      .icon-afternoon::before {
        content: "â˜€ï¸";
      }
      .icon-evening::before {
        content: "ğŸŒ†";
      }
      .icon-night::before {
        content: "ğŸŒ™";
      }
      .iconfont {
        font-style: normal;
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: [
                "-apple-system",
                "BlinkMacSystemFont",
                "Segoe UI",
                "Microsoft YaHei",
                "sans-serif"
              ]
            },
            animation: {
              "fade-in": "fadeIn 0.5s ease-in-out",
              "slide-down": "slideDown 0.4s ease-out",
              "slide-up": "slideUp 0.4s ease-out"
            }
          }
        }
      }
    </script>
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes slideDown {
        from {
          opacity: 0;
          max-height: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          max-height: 1000px;
          transform: translateY(0);
        }
      }
      @keyframes slideUp {
        from {
          opacity: 1;
          max-height: 1000px;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          max-height: 0;
          transform: translateY(-20px);
        }
      }
      .search-highlight {
        background-color: #fef3c7;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
        color: #92400e;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-blue-50 via-sky-50 to-cyan-50 min-h-screen font-sans"
  >
    <div class="max-w-7xl mx-auto px-4 py-6">
      <!-- é¡µé¢å¤´éƒ¨ -->
      <div class="text-center mb-8">
        <h1
          class="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-blue-600 via-cyan-600 to-blue-800 bg-clip-text text-transparent animate-fade-in"
        >
          <i class="iconfont icon-airplane text-blue-500 mr-3"></i>
          æµ·èˆª666éšå¿ƒé£
        </h1>
        <p class="text-lg text-gray-600 font-medium">
          èˆªçº¿è§„åˆ’å™¨ Â· æ™ºèƒ½ç­›é€‰ Â· ä¸€é”®æŸ¥è¯¢
        </p>
        <div class="flex justify-center items-center gap-4 mt-4">
          <span
            class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800"
          >
            <i class="iconfont icon-status mr-1"></i>
            ç³»ç»Ÿæ­£å¸¸
          </span>
          <span
            class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800"
          >
            <i class="iconfont icon-available mr-1"></i>
            2666å¯ç”¨
          </span>
        </div>
      </div>

      <!-- å¿«æ·æœç´¢åŒºåŸŸ -->
      <div
        class="bg-white/80 backdrop-blur-lg rounded-2xl shadow-xl p-6 mb-6 border border-white/20 animate-fade-in"
      >
        <div class="flex flex-col gap-6">
          <!-- æœç´¢æ ‡é¢˜ -->
          <div class="text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-2">
              <i class="iconfont icon-search text-blue-500 mr-2 text-xl"></i>
              èˆªç­æœç´¢
            </h3>
            <p class="text-sm text-gray-600">
              é€‰æ‹©å‡ºå‘åŸå¸‚å’Œç›®çš„åœ°åŸå¸‚ï¼Œå¿«é€ŸæŸ¥æ‰¾èˆªç­
            </p>
          </div>

          <!-- åŸå¸‚æœç´¢åŒºåŸŸ -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- å‡ºå‘åŸå¸‚æœç´¢æ¡† -->
            <div class="relative">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                <i
                  class="iconfont icon-departure text-green-500 mr-2 text-lg"
                ></i>
                å‡ºå‘åŸå¸‚
              </label>
              <div class="relative group">
                <input
                  type="text"
                  id="departureSearch"
                  class="w-full pl-12 pr-12 py-4 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:ring-4 focus:ring-green-100 transition-all duration-300 bg-gray-50/50 focus:bg-white text-gray-800 placeholder-gray-400 shadow-sm hover:shadow-md"
                  placeholder="è¯·è¾“å…¥å‡ºå‘åŸå¸‚..."
                  oninput="handleCityInputChange('departureSearch')"
                  onfocus="handleCityInputFocus('departureSearch')"
                  onblur="handleCityInputBlur('departureSearch')"
                  onkeydown="handleCityInputKeydown(event, 'departureSearch')"
                  autocomplete="off"
                />
                <!-- å‡ºå‘å›¾æ ‡ -->
                <i
                  class="iconfont icon-departure absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-xl group-focus-within:text-green-500 transition-colors"
                ></i>
                <!-- æ¸…é™¤æŒ‰é’® -->
                <button
                  onclick="clearDepartureSearch()"
                  class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-red-500 transition-all duration-200 hover:scale-110 p-1 rounded-full hover:bg-red-50"
                  title="æ¸…ç©ºå‡ºå‘åŸå¸‚"
                >
                  <i class="iconfont icon-close text-lg"></i>
                </button>
                <!-- ä¸‹æ‹‰é€‰æ‹©åˆ—è¡¨ -->
                <div
                  id="departureSearchDropdown"
                  class="absolute top-full left-0 right-0 bg-white border-2 border-gray-200 rounded-xl shadow-lg z-50 max-h-60 overflow-y-auto hidden mt-1"
                  style="display: none"
                >
                  <!-- åŠ¨æ€ç”Ÿæˆçš„åŸå¸‚é€‰é¡¹ -->
                </div>
              </div>
            </div>

            <!-- ç›®çš„åœ°åŸå¸‚æœç´¢æ¡† -->
            <div class="relative">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                <i class="iconfont icon-arrival text-red-500 mr-2 text-lg"></i>
                ç›®çš„åœ°åŸå¸‚
              </label>
              <div class="relative group">
                <input
                  type="text"
                  id="destinationSearch"
                  class="w-full pl-12 pr-12 py-4 border-2 border-gray-200 rounded-xl focus:border-red-500 focus:ring-4 focus:ring-red-100 transition-all duration-300 bg-gray-50/50 focus:bg-white text-gray-800 placeholder-gray-400 shadow-sm hover:shadow-md"
                  placeholder="è¯·è¾“å…¥ç›®çš„åœ°åŸå¸‚..."
                  oninput="handleCityInputChange('destinationSearch')"
                  onfocus="handleCityInputFocus('destinationSearch')"
                  onblur="handleCityInputBlur('destinationSearch')"
                  onkeydown="handleCityInputKeydown(event, 'destinationSearch')"
                  autocomplete="off"
                />
                <!-- åˆ°è¾¾å›¾æ ‡ -->
                <i
                  class="iconfont icon-arrival absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-xl group-focus-within:text-red-500 transition-colors"
                ></i>
                <!-- æ¸…é™¤æŒ‰é’® -->
                <button
                  onclick="clearDestinationSearch()"
                  class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-red-500 transition-all duration-200 hover:scale-110 p-1 rounded-full hover:bg-red-50"
                  title="æ¸…ç©ºç›®çš„åœ°åŸå¸‚"
                >
                  <i class="iconfont icon-close text-lg"></i>
                </button>
                <!-- ä¸‹æ‹‰é€‰æ‹©åˆ—è¡¨ -->
                <div
                  id="destinationSearchDropdown"
                  class="absolute top-full left-0 right-0 bg-white border-2 border-gray-200 rounded-xl shadow-lg z-50 max-h-60 overflow-y-auto hidden mt-1"
                  style="display: none"
                >
                  <!-- åŠ¨æ€ç”Ÿæˆçš„åŸå¸‚é€‰é¡¹ -->
                </div>
              </div>
            </div>
          </div>

          <!-- è¡Œç¨‹ç±»å‹å’Œæœç´¢æŒ‰é’® -->
          <div
            class="flex flex-col sm:flex-row gap-4 items-center justify-between"
          >
            <!-- è¡Œç¨‹ç±»å‹é€‰æ‹© -->
            <div class="flex items-center gap-4">
              <span class="text-sm font-semibold text-gray-700">
                <i class="iconfont icon-calendar text-blue-500 mr-2"></i>
                è¡Œç¨‹ç±»å‹:
              </span>
              <div class="flex gap-2">
                <button
                  class="trip-type-btn active px-4 py-2 text-sm rounded-full border-2 border-blue-500 bg-blue-500 text-white hover:bg-blue-600 transition-all duration-200 font-medium"
                  data-type="round-trip"
                  onclick="selectTripType('round-trip')"
                >
                  å¾€è¿”
                </button>
                <button
                  class="trip-type-btn px-4 py-2 text-sm rounded-full border-2 border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 font-medium"
                  data-type="one-way"
                  onclick="selectTripType('one-way')"
                >
                  å•ç¨‹
                </button>
              </div>
            </div>

            <!-- è¯¦ç»†æœç´¢åˆ‡æ¢æŒ‰é’® -->
            <div class="flex-shrink-0">
              <button
                class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-8 py-4 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl flex items-center gap-3 font-semibold hover:-translate-y-1 active:translate-y-0"
                id="toggleBtn"
                onclick="toggleAdvancedSearch()"
              >
                <i class="iconfont icon-filter text-lg"></i>
                <span id="toggleText">è¯¦ç»†æœç´¢</span>
                <i
                  class="iconfont icon-arrow-down transition-transform duration-300"
                  id="toggleIcon"
                ></i>
              </button>
            </div>
          </div>

          <!-- å¿«æ·ç­›é€‰æ¡ä»¶ -->
          <div class="border-t border-gray-200 pt-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- æ—¶é—´æ®µç­›é€‰ -->
              <div>
                <div class="flex flex-wrap items-center gap-3 mb-4">
                  <span
                    class="text-sm font-semibold text-gray-700 flex items-center"
                  >
                    <i class="iconfont icon-time text-blue-500 mr-2"></i>
                    æ—¶é—´æ®µç­›é€‰:
                  </span>
                </div>
                <div class="flex flex-wrap gap-2">
                  <button
                    class="time-filter-btn active px-3 py-2 text-xs rounded-full border-2 border-blue-500 bg-blue-500 text-white hover:bg-blue-600 transition-all duration-200 font-medium"
                    data-time="all"
                    onclick="selectTimeFilter('all')"
                  >
                    å…¨éƒ¨æ—¶æ®µ
                  </button>
                  <button
                    class="time-filter-btn px-3 py-2 text-xs rounded-full border-2 border-orange-300 text-orange-700 hover:border-orange-500 hover:bg-orange-50 transition-all duration-200 font-medium"
                    data-time="night"
                    onclick="selectTimeFilter('night')"
                  >
                    <i class="iconfont icon-night mr-1"></i>æ™šä¸Š 18:00-24:00
                  </button>
                  <button
                    class="time-filter-btn px-3 py-2 text-xs rounded-full border-2 border-purple-300 text-purple-700 hover:border-purple-500 hover:bg-purple-50 transition-all duration-200 font-medium"
                    data-time="early"
                    onclick="selectTimeFilter('early')"
                  >
                    <i class="iconfont icon-early mr-1"></i>å‡Œæ™¨ 00:00-06:00
                  </button>
                </div>
              </div>

              <!-- å¯ç”¨æ€§å’Œèˆªæ®µç­›é€‰ -->
              <div>
                <div class="flex flex-wrap items-center gap-3 mb-4">
                  <span
                    class="text-sm font-semibold text-gray-700 flex items-center"
                  >
                    <i class="iconfont icon-status text-green-500 mr-2"></i>
                    ç­›é€‰æ¡ä»¶:
                  </span>
                </div>
                <div class="flex flex-wrap gap-2">
                  <button
                    class="availability-filter-btn px-3 py-2 text-xs rounded-full border-2 border-green-300 text-green-700 hover:border-green-500 hover:bg-green-50 transition-all duration-200 font-medium"
                    data-availability="2666"
                    onclick="toggleAvailabilityFilter('2666')"
                  >
                    <i class="iconfont icon-available mr-1"></i>2666å¯ç”¨
                  </button>
                  <select
                    id="segmentFilter"
                    class="px-3 py-2 text-xs border-2 border-gray-300 rounded-full focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all duration-200 bg-white font-medium"
                    onchange="selectSegmentFilter(this.value)"
                  >
                    <option value="">å…¨éƒ¨èˆªæ®µ</option>
                    <option value="1">1èˆªæ®µ</option>
                    <option value="2">2èˆªæ®µ</option>
                    <option value="3">3èˆªæ®µ</option>
                    <option value="4+">4+èˆªæ®µ</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- æœç´¢æç¤ºä¿¡æ¯ -->
        <div class="mt-4" id="searchResultsInfo">
          <div
            class="flex items-center gap-4 text-sm text-gray-600 bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 rounded-xl border border-blue-100 shadow-sm"
          >
            <i
              class="iconfont icon-tips text-blue-500 text-xl animate-pulse"
            ></i>
            <span class="font-medium"
              >é€‰æ‹©å‡ºå‘åŸå¸‚å’Œç›®çš„åœ°åŸå¸‚ï¼Œä½¿ç”¨ç­›é€‰æ¡ä»¶ç²¾ç¡®æŸ¥æ‰¾èˆªç­ Â·
              æ”¯æŒæ—¶é—´æ®µã€è¡Œç¨‹ç±»å‹å’Œèˆªæ®µç­›é€‰</span
            >
          </div>
        </div>
      </div>

      <!-- è¯¦ç»†æœç´¢é¢æ¿ -->
      <div
        class="bg-white/90 backdrop-blur-lg rounded-2xl shadow-xl p-6 mb-6 border border-white/30 transition-all duration-500"
        id="advancedFilters"
        style="display: none"
      >
        <!-- åŸºç¡€ç­›é€‰å¡ç‰‡ -->
        <div
          class="bg-gradient-to-r from-blue-50/50 to-indigo-50/50 rounded-xl p-5 mb-5 border border-blue-100"
        >
          <h4
            class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"
          >
            <i class="iconfont icon-filter text-blue-500"></i>
            åŸºç¡€ç­›é€‰
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="relative group">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="iconfont icon-airplane text-blue-500 mr-1"></i
                >èˆªç©ºå…¬å¸
              </label>
              <select
                id="airline"
                class="w-full px-3 py-2.5 border border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all duration-200 bg-white shadow-sm hover:shadow-md text-sm"
              >
                <option value="">å…¨éƒ¨</option>
              </select>
            </div>

            <div class="relative group">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="iconfont icon-departure text-green-500 mr-1"></i
                >å‡ºå‘åŸå¸‚
              </label>
              <select
                id="departure"
                class="w-full px-3 py-2.5 border border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all duration-200 bg-white shadow-sm hover:shadow-md text-sm"
              >
                <option value="">å…¨éƒ¨</option>
              </select>
            </div>

            <div class="relative group">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="iconfont icon-arrival text-red-500 mr-1"></i>åˆ°è¾¾åŸå¸‚
              </label>
              <select
                id="destination"
                class="w-full px-3 py-2.5 border border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all duration-200 bg-white shadow-sm hover:shadow-md text-sm"
              >
                <option value="">å…¨éƒ¨</option>
              </select>
            </div>

            <div class="relative group">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="iconfont icon-location text-purple-500 mr-1"></i
                >å‡ºå‘çœä»½
              </label>
              <select
                id="departureProvince"
                class="w-full px-3 py-2.5 border border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all duration-200 bg-white shadow-sm hover:shadow-md text-sm"
              >
                <option value="">å…¨éƒ¨</option>
              </select>
            </div>

            <div class="relative group">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="iconfont icon-location text-indigo-500 mr-1"></i
                >åˆ°è¾¾çœä»½
              </label>
              <select
                id="destinationProvince"
                class="w-full px-3 py-2.5 border border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all duration-200 bg-white shadow-sm hover:shadow-md text-sm"
              >
                <option value="">å…¨éƒ¨</option>
              </select>
            </div>

            <div class="relative group">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="iconfont icon-flight-number text-orange-500 mr-1"></i
                >èˆªç­å·
              </label>
              <input
                type="text"
                id="flightNumber"
                placeholder="è¾“å…¥èˆªç­å·"
                class="w-full px-3 py-2.5 border border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all duration-200 bg-white shadow-sm hover:shadow-md text-sm"
              />
            </div>
          </div>
        </div>

        <!-- èˆªç­ç±»å‹ç­›é€‰å¡ç‰‡ -->
        <div
          class="bg-gradient-to-r from-green-50/50 to-emerald-50/50 rounded-xl p-5 mb-5 border border-green-100"
        >
          <h4
            class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"
          >
            <i class="iconfont icon-type text-green-500"></i>
            èˆªç­ç±»å‹
          </h4>
          <div class="flex flex-wrap gap-3">
            <label
              class="flex items-center space-x-2 cursor-pointer group bg-white px-3 py-2 rounded-lg border border-gray-200 hover:border-green-300 hover:bg-green-50/30 transition-all duration-200"
            >
              <input
                type="checkbox"
                id="flightType-passenger"
                value="passenger"
                class="w-4 h-4 text-green-600 border-2 border-gray-300 rounded focus:ring-green-500 focus:ring-2 transition-all duration-200"
              />
              <span
                class="text-sm font-medium text-gray-700 group-hover:text-green-600 transition-colors duration-200"
                >å®¢è¿èˆªç­</span
              >
            </label>
            <label
              class="flex items-center space-x-2 cursor-pointer group bg-white px-3 py-2 rounded-lg border border-gray-200 hover:border-green-300 hover:bg-green-50/30 transition-all duration-200"
            >
              <input
                type="checkbox"
                id="flightType-cargo"
                value="cargo"
                class="w-4 h-4 text-green-600 border-2 border-gray-300 rounded focus:ring-green-500 focus:ring-2 transition-all duration-200"
              />
              <span
                class="text-sm font-medium text-gray-700 group-hover:text-green-600 transition-colors duration-200"
                >è´§è¿èˆªç­</span
              >
            </label>
            <label
              class="flex items-center space-x-2 cursor-pointer group bg-white px-3 py-2 rounded-lg border border-gray-200 hover:border-green-300 hover:bg-green-50/30 transition-all duration-200"
            >
              <input
                type="checkbox"
                id="nightFlight"
                value="true"
                class="w-4 h-4 text-green-600 border-2 border-gray-300 rounded focus:ring-green-500 focus:ring-2 transition-all duration-200"
              />
              <span
                class="text-sm font-medium text-gray-700 group-hover:text-green-600 transition-colors duration-200"
                >çº¢çœ¼èˆªç­</span
              >
            </label>
            <label
              class="flex items-center space-x-2 cursor-pointer group bg-white px-3 py-2 rounded-lg border border-gray-200 hover:border-green-300 hover:bg-green-50/30 transition-all duration-200"
            >
              <input
                type="checkbox"
                id="dayFlight"
                value="true"
                class="w-4 h-4 text-green-600 border-2 border-gray-300 rounded focus:ring-green-500 focus:ring-2 transition-all duration-200"
              />
              <span
                class="text-sm font-medium text-gray-700 group-hover:text-green-600 transition-colors duration-200"
                >æ—¥é—´èˆªç­</span
              >
            </label>
          </div>
        </div>

        <!-- æ—¶é—´ç­›é€‰å¡ç‰‡ -->
        <div
          class="bg-gradient-to-r from-orange-50/50 to-amber-50/50 rounded-xl p-5 mb-5 border border-orange-100"
        >
          <h4
            class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"
          >
            <i class="iconfont icon-time text-orange-500"></i>
            æ—¶é—´ç­›é€‰
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >èµ·é£æ—¶é—´æ®µ</label
              >
              <select
                id="departureTime"
                class="w-full px-3 py-2.5 border border-gray-200 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-100 transition-all duration-200 bg-white shadow-sm text-sm"
              >
                <option value="">å…¨éƒ¨</option>
                <option value="early">å‡Œæ™¨ (00:00-06:00)</option>
                <option value="morning">ä¸Šåˆ (06:00-12:00)</option>
                <option value="afternoon">ä¸‹åˆ (12:00-18:00)</option>
                <option value="evening">æ™šä¸Š (18:00-24:00)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >è‡ªå®šä¹‰æ—¶é—´èŒƒå›´</label
              >
              <div class="flex gap-2">
                <select
                  id="departureTimeStart"
                  class="flex-1 px-3 py-2 border border-gray-200 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-100 transition-all duration-200 bg-white shadow-sm text-sm"
                >
                  <option value="">å¼€å§‹æ—¶é—´</option>
                  <option value="00:00">00:00</option>
                  <option value="06:00">06:00</option>
                  <option value="12:00">12:00</option>
                  <option value="18:00">18:00</option>
                </select>
                <span class="flex items-center text-gray-400">-</span>
                <select
                  id="departureTimeEnd"
                  class="flex-1 px-3 py-2 border border-gray-200 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-100 transition-all duration-200 bg-white shadow-sm text-sm"
                >
                  <option value="">ç»“æŸæ—¶é—´</option>
                  <option value="06:00">06:00</option>
                  <option value="12:00">12:00</option>
                  <option value="18:00">18:00</option>
                  <option value="23:59">23:59</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- è¿è¥æ—¥æœŸç­›é€‰å¡ç‰‡ -->
        <div
          class="bg-gradient-to-r from-purple-50/50 to-violet-50/50 rounded-xl p-5 mb-5 border border-purple-100"
        >
          <h4
            class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"
          >
            <i class="iconfont icon-calendar text-purple-500"></i>
            è¿è¥æ—¥æœŸ
          </h4>
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2">
            <label
              class="flex items-center justify-center space-x-1 cursor-pointer group bg-white px-2 py-2 rounded-lg border border-gray-200 hover:border-purple-300 hover:bg-purple-50/30 transition-all duration-200"
            >
              <input
                type="checkbox"
                class="day-checkbox w-4 h-4 text-purple-600 border-2 border-gray-300 rounded focus:ring-purple-500 focus:ring-2 transition-all duration-200"
                value="1"
              />
              <span
                class="text-sm font-medium text-gray-700 group-hover:text-purple-600 transition-colors duration-200"
                >å‘¨ä¸€</span
              >
            </label>
            <label
              class="flex items-center justify-center space-x-1 cursor-pointer group bg-white px-2 py-2 rounded-lg border border-gray-200 hover:border-purple-300 hover:bg-purple-50/30 transition-all duration-200"
            >
              <input
                type="checkbox"
                class="day-checkbox w-4 h-4 text-purple-600 border-2 border-gray-300 rounded focus:ring-purple-500 focus:ring-2 transition-all duration-200"
                value="2"
              />
              <span
                class="text-sm font-medium text-gray-700 group-hover:text-purple-600 transition-colors duration-200"
                >å‘¨äºŒ</span
              >
            </label>
            <label
              class="flex items-center justify-center space-x-1 cursor-pointer group bg-white px-2 py-2 rounded-lg border border-gray-200 hover:border-purple-300 hover:bg-purple-50/30 transition-all duration-200"
            >
              <input
                type="checkbox"
                class="day-checkbox w-4 h-4 text-purple-600 border-2 border-gray-300 rounded focus:ring-purple-500 focus:ring-2 transition-all duration-200"
                value="3"
              />
              <span
                class="text-sm font-medium text-gray-700 group-hover:text-purple-600 transition-colors duration-200"
                >å‘¨ä¸‰</span
              >
            </label>
            <label
              class="flex items-center justify-center space-x-1 cursor-pointer group bg-white px-2 py-2 rounded-lg border border-gray-200 hover:border-purple-300 hover:bg-purple-50/30 transition-all duration-200"
            >
              <input
                type="checkbox"
                class="day-checkbox w-4 h-4 text-purple-600 border-2 border-gray-300 rounded focus:ring-purple-500 focus:ring-2 transition-all duration-200"
                value="4"
              />
              <span
                class="text-sm font-medium text-gray-700 group-hover:text-purple-600 transition-colors duration-200"
                >å‘¨å››</span
              >
            </label>
            <label
              class="flex items-center justify-center space-x-1 cursor-pointer group bg-white px-2 py-2 rounded-lg border border-gray-200 hover:border-purple-300 hover:bg-purple-50/30 transition-all duration-200"
            >
              <input
                type="checkbox"
                class="day-checkbox w-4 h-4 text-purple-600 border-2 border-gray-300 rounded focus:ring-purple-500 focus:ring-2 transition-all duration-200"
                value="5"
              />
              <span
                class="text-sm font-medium text-gray-700 group-hover:text-purple-600 transition-colors duration-200"
                >å‘¨äº”</span
              >
            </label>
            <label
              class="flex items-center justify-center space-x-1 cursor-pointer group bg-white px-2 py-2 rounded-lg border border-gray-200 hover:border-purple-300 hover:bg-purple-50/30 transition-all duration-200"
            >
              <input
                type="checkbox"
                class="day-checkbox w-4 h-4 text-purple-600 border-2 border-gray-300 rounded focus:ring-purple-500 focus:ring-2 transition-all duration-200"
                value="6"
              />
              <span
                class="text-sm font-medium text-gray-700 group-hover:text-purple-600 transition-colors duration-200"
                >å‘¨å…­</span
              >
            </label>
            <label
              class="flex items-center justify-center space-x-1 cursor-pointer group bg-white px-2 py-2 rounded-lg border border-gray-200 hover:border-purple-300 hover:bg-purple-50/30 transition-all duration-200"
            >
              <input
                type="checkbox"
                class="day-checkbox w-4 h-4 text-purple-600 border-2 border-gray-300 rounded focus:ring-purple-500 focus:ring-2 transition-all duration-200"
                value="7"
              />
              <span
                class="text-sm font-medium text-gray-700 group-hover:text-purple-600 transition-colors duration-200"
                >å‘¨æ—¥</span
              >
            </label>
          </div>
        </div>

        <!-- æŒ‰é’®ç»„ -->
        <div class="flex flex-col sm:flex-row gap-4">
          <button
            class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl font-semibold hover:-translate-y-1 active:translate-y-0"
            onclick="applyFilters()"
          >
            <i class="iconfont icon-check mr-2"></i>
            åº”ç”¨ç­›é€‰
          </button>
          <button
            class="flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-6 py-3 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl font-semibold hover:-translate-y-1 active:translate-y-0"
            onclick="resetFilters()"
          >
            <i class="iconfont icon-refresh mr-2"></i>
            é‡ç½®ç­›é€‰
          </button>
        </div>
      </div>

      <!-- æŸ¥è¯¢ç»“æœä¿¡æ¯ -->
      <div
        class="bg-white/90 backdrop-blur-lg rounded-2xl shadow-xl p-6 mb-6 border border-white/30"
      >
        <div
          class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6"
        >
          <div class="flex-1">
            <div class="flex items-center justify-between mb-4">
              <h3
                class="text-xl font-bold text-gray-800 flex items-center gap-2"
              >
                <i class="iconfont icon-airplane text-blue-500 text-2xl"></i>
                èˆªç­æŸ¥è¯¢ç»“æœ
              </h3>
              <div class="flex items-center gap-2">
                <span
                  class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"
                >
                  <i class="iconfont icon-status mr-1"></i>
                  å®æ—¶æ›´æ–°
                </span>
                <span
                  class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                  id="filterStatus"
                >
                  <i class="iconfont icon-filter mr-1"></i>
                  æ— ç­›é€‰æ¡ä»¶
                </span>
              </div>
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
              <div
                class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl border border-blue-200 hover:shadow-md transition-all duration-200"
              >
                <i class="iconfont icon-airplane text-blue-500 text-xl"></i>
                <div>
                  <span class="text-xs text-gray-600 block">æ€»èˆªç­æ•°</span>
                  <span
                    class="text-lg font-bold text-blue-600"
                    id="totalFlights"
                    >0</span
                  >
                </div>
              </div>

              <div
                class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl border border-purple-200 hover:shadow-md transition-all duration-200"
              >
                <i class="iconfont icon-night text-purple-500 text-xl"></i>
                <div>
                  <span class="text-xs text-gray-600 block">çº¢çœ¼èˆªç­</span>
                  <span
                    class="text-lg font-bold text-purple-600"
                    id="nightFlights"
                    >0</span
                  >
                </div>
              </div>

              <div
                class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-orange-50 to-orange-100 rounded-xl border border-orange-200 hover:shadow-md transition-all duration-200"
              >
                <i class="iconfont icon-sun text-orange-500 text-xl"></i>
                <div>
                  <span class="text-xs text-gray-600 block">æ—¥é—´èˆªç­</span>
                  <span
                    class="text-lg font-bold text-orange-600"
                    id="dayFlights"
                    >0</span
                  >
                </div>
              </div>

              <div
                class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border-2 border-purple-300 hover:shadow-lg transition-all duration-200 ring-2 ring-purple-100"
              >
                <div class="relative">
                  <i class="iconfont icon-star text-purple-500 text-xl"></i>
                  <span
                    class="absolute -top-1 -right-1 w-3 h-3 bg-purple-500 rounded-full animate-pulse"
                  ></span>
                </div>
                <div>
                  <span class="text-xs text-purple-600 block font-semibold"
                    >2666å¯ç”¨</span
                  >
                  <span
                    class="text-lg font-bold text-purple-600"
                    id="availableFlights"
                    >0</span
                  >
                </div>
                <div class="ml-auto">
                  <span
                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800"
                  >
                    <span
                      class="w-1.5 h-1.5 bg-purple-500 rounded-full mr-1 animate-pulse"
                    ></span>
                    ä¸“äº«
                  </span>
                </div>
              </div>

              <div
                class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-cyan-50 to-cyan-100 rounded-xl border border-cyan-200 hover:shadow-md transition-all duration-200"
              >
                <i class="iconfont icon-time text-cyan-500 text-xl"></i>
                <div>
                  <span class="text-xs text-gray-600 block">å½“å‰æ—¶æ®µ</span>
                  <span
                    class="text-lg font-bold text-cyan-600"
                    id="currentTimeSlot"
                    >å…¨éƒ¨</span
                  >
                </div>
              </div>
            </div>
          </div>

          <div class="flex flex-col gap-3">
            <button
              class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-3 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl font-semibold hover:-translate-y-1 active:translate-y-0 flex items-center gap-2"
              onclick="exportResults()"
            >
              <i class="iconfont icon-export text-lg"></i>
              å¯¼å‡ºç»“æœ
            </button>
            <button
              class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl font-semibold hover:-translate-y-1 active:translate-y-0 flex items-center gap-2"
              onclick="refreshData()"
            >
              <i class="iconfont icon-reset text-lg"></i>
              åˆ·æ–°æ•°æ®
            </button>
          </div>
        </div>
      </div>

      <!-- èˆªç­åˆ—è¡¨ -->
      <div
        class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100"
      >
        <div class="overflow-x-auto">
          <table id="flightTable" class="w-full">
            <thead>
              <tr
                class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white"
              >
                <th class="px-6 py-4 text-left font-semibold">
                  <i class="iconfont icon-airplane mr-2"></i>èˆªç©ºå…¬å¸
                </th>
                <th class="px-6 py-4 text-left font-semibold">
                  <i class="iconfont icon-flight-number mr-2"></i>èˆªç­å·
                </th>
                <th class="px-6 py-4 text-left font-semibold">
                  <i class="iconfont icon-departure mr-2"></i>å‡ºå‘åŸå¸‚
                </th>
                <th class="px-6 py-4 text-left font-semibold">
                  <i class="iconfont icon-arrival mr-2"></i>åˆ°è¾¾åŸå¸‚
                </th>
                <th class="px-6 py-4 text-left font-semibold">
                  <i class="iconfont icon-time mr-2"></i>å‡ºå‘æ—¶é—´
                </th>
                <th class="px-6 py-4 text-left font-semibold">
                  <i class="iconfont icon-time mr-2"></i>åˆ°è¾¾æ—¶é—´
                </th>
                <th class="px-6 py-4 text-left font-semibold">
                  <i class="iconfont icon-calendar mr-2"></i>è¿è¥æ—¥æœŸ
                </th>
                <th class="px-6 py-4 text-left font-semibold">
                  <i class="iconfont icon-product mr-2"></i>äº§å“ç±»å‹
                </th>
                <th class="px-6 py-4 text-left font-semibold">
                  <i class="iconfont icon-type mr-2"></i>èˆªç­ç±»å‹
                </th>
              </tr>
            </thead>
            <tbody id="flightTableBody" class="divide-y divide-gray-100">
              <tr>
                <td
                  colspan="9"
                  class="px-6 py-12 text-center text-gray-500 animate-pulse"
                >
                  <i class="iconfont icon-loading text-3xl mb-2 block"></i>
                  æ­£åœ¨åŠ è½½æ•°æ®...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      let flightData = []
      let filteredData = []
      let originalFilteredData = [] // ä¿å­˜åŸå§‹ç­›é€‰ç»“æœï¼Œç”¨äºåŸå¸‚æœç´¢
      let filters = {
        airline: "",
        departure: "",
        destination: "",
        departureProvince: "",
        destinationProvince: "",
        flightNumber: "",
        productType: "",
        nightFlight: false,
        dayFlight: false,
        departureTime: "",
        operatingDays: [],
        timeSlot: "all",
        quickTimeFilter: "å…¨éƒ¨æ—¶æ®µ",
        tripType: "å•ç¨‹",
        available2666: false,
        segment: "all"
      } // å…¨å±€ç­›é€‰æ¡ä»¶å¯¹è±¡

      // åŠ è½½èˆªç­æ•°æ®
      async function loadFlightData() {
        console.log("å¼€å§‹åŠ è½½èˆªç­æ•°æ®...")
        document.getElementById("flightTableBody").innerHTML =
          '<tr><td colspan="9" class="no-results">æ­£åœ¨åŠ è½½æ•°æ®ï¼Œè¯·ç¨å€™...</td></tr>'

        try {
          console.log("åŠ è½½æœ¬åœ°æ•°æ®: ./flights_data.json")
          const response = await fetch("./flights_data.json")

          if (!response.ok) {
            throw new Error(
              `HTTPé”™è¯¯: ${response.status} ${response.statusText}`
            )
          }

          const data = await response.json()
          console.log("æˆåŠŸåŠ è½½æœ¬åœ°æ•°æ®:", data)
          console.log("èˆªç­æ•°é‡:", data.flights ? data.flights.length : 0)

          if (!data.flights || !Array.isArray(data.flights)) {
            throw new Error("æ•°æ®æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘flightsæ•°ç»„")
          }

          flightData = data.flights
          console.log("æœ¬åœ°æ•°æ®åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–ç­›é€‰å™¨")
          initializeFilters()
          filteredData = [...flightData]
          displayResults()
          console.log("é¡µé¢åˆå§‹åŒ–å®Œæˆ")
        } catch (error) {
          console.error("æœ¬åœ°æ•°æ®åŠ è½½å¤±è´¥:", error)
          console.error("é”™è¯¯è¯¦æƒ…:", error.message)

          // ä½¿ç”¨å¤‡ç”¨ç¤ºä¾‹æ•°æ®
          console.log("ä½¿ç”¨å¤‡ç”¨ç¤ºä¾‹æ•°æ®")
          flightData = getBackupFlightData()

          if (flightData.length > 0) {
            console.log("å¤‡ç”¨æ•°æ®åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–ç­›é€‰å™¨")
            initializeFilters()
            filteredData = [...flightData]
            displayResults()

            // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
            document.getElementById("searchResultsInfo").innerHTML = `
              <div class="flex items-center gap-4 text-sm text-orange-600 bg-gradient-to-r from-orange-50 to-yellow-50 px-6 py-4 rounded-xl border border-orange-200 shadow-sm">
                <i class="iconfont icon-warning text-orange-500 text-xl"></i>
                <span class="font-medium">æ­£åœ¨ä½¿ç”¨ç¤ºä¾‹æ•°æ® Â· æœ¬åœ°æ•°æ®åŠ è½½å¤±è´¥: ${error.message}</span>
                <button class="ml-auto px-3 py-1 bg-orange-500 text-white rounded-lg text-xs hover:bg-orange-600" onclick="loadFlightData()">é‡è¯•åŠ è½½</button>
              </div>
            `
          } else {
            document.getElementById(
              "flightTableBody"
            ).innerHTML = `<tr><td colspan="9" class="no-results">æ•°æ®åŠ è½½å¤±è´¥: ${error.message}<br><br>å¯èƒ½çš„åŸå› ï¼š<br>1. æœ¬åœ°æ–‡ä»¶ flights_data.json ä¸å­˜åœ¨<br>2. æ–‡ä»¶æ ¼å¼é”™è¯¯<br>3. æ–‡ä»¶è¯»å–æƒé™é—®é¢˜<br><br><button class="btn-primary" onclick="loadFlightData()">é‡è¯•</button></td></tr>`
          }
        }
      }

      // åˆå§‹åŒ–ç­›é€‰å™¨é€‰é¡¹
      function initializeFilters() {
        console.log("å¼€å§‹åˆå§‹åŒ–ç­›é€‰å™¨é€‰é¡¹...")

        // ç¡®ä¿æ•°æ®å·²åŠ è½½
        if (!flightData || flightData.length === 0) {
          console.warn("èˆªç­æ•°æ®æœªåŠ è½½ï¼Œæ— æ³•åˆå§‹åŒ–ç­›é€‰å™¨")
          return
        }

        // ä»èˆªç­æ•°æ®ä¸­æå–å”¯ä¸€å€¼å¹¶æ’åº
        const airlines = [
          ...new Set(flightData.map((f) => f.airline).filter(Boolean))
        ].sort()
        const departures = [
          ...new Set(flightData.map((f) => f.departure).filter(Boolean))
        ].sort()
        const destinations = [
          ...new Set(flightData.map((f) => f.destination).filter(Boolean))
        ].sort()
        const departureProvinces = [
          ...new Set(
            flightData.map((f) => f.departure_province).filter(Boolean)
          )
        ].sort()
        const destinationProvinces = [
          ...new Set(
            flightData.map((f) => f.destination_province).filter(Boolean)
          )
        ].sort()
        const productTypes = [
          ...new Set(flightData.map((f) => f.product_type).filter(Boolean))
        ].sort()

        // è·å–èˆªæ®µä¿¡æ¯
        const segments = [
          ...new Set(
            flightData.map((f) => f.segment || f.segments).filter(Boolean)
          )
        ].sort()

        // è·å–èˆªç©ºå…¬å¸ä»£ç ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        const airlineCodes = [
          ...new Set(flightData.map((f) => f.airline_code).filter(Boolean))
        ].sort()

        console.log("æå–çš„æ•°æ®ç»Ÿè®¡:")
        console.log("- èˆªç©ºå…¬å¸:", airlines.length, "ä¸ª")
        console.log("- å‡ºå‘åŸå¸‚:", departures.length, "ä¸ª")
        console.log("- ç›®çš„åœ°åŸå¸‚:", destinations.length, "ä¸ª")
        console.log("- å‡ºå‘çœä»½:", departureProvinces.length, "ä¸ª")
        console.log("- ç›®çš„åœ°çœä»½:", destinationProvinces.length, "ä¸ª")
        console.log("- äº§å“ç±»å‹:", productTypes.length, "ä¸ª")
        console.log("- èˆªæ®µ:", segments.length, "ä¸ª")

        // æ¸…ç©ºå¹¶å¡«å……ä¸‹æ‹‰é€‰é¡¹
        clearAndPopulateSelect("airline", airlines)
        clearAndPopulateSelect("departure", departures)
        clearAndPopulateSelect("destination", destinations)
        clearAndPopulateSelect("departureProvince", departureProvinces)
        clearAndPopulateSelect("destinationProvince", destinationProvinces)
        // äº§å“ç±»å‹é€šè¿‡2666å¯ç”¨æŒ‰é’®å¤„ç†ï¼Œä¸éœ€è¦ä¸‹æ‹‰é€‰æ‹©å™¨

        // å¡«å……èˆªæ®µç­›é€‰å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (segments.length > 0) {
          clearAndPopulateSelect("segmentFilter", segments, "å…¨éƒ¨èˆªæ®µ")
        }

        console.log("ç­›é€‰å™¨é€‰é¡¹åˆå§‹åŒ–å®Œæˆ")

        // åˆå§‹åŒ–åŸå¸‚æ•°æ®
        initializeCityData()
      }

      // æ¸…ç©ºå¹¶å¡«å……ä¸‹æ‹‰é€‰é¡¹
      function clearAndPopulateSelect(id, options, defaultText = "å…¨éƒ¨") {
        const select = document.getElementById(id)
        if (!select) {
          console.warn(`æœªæ‰¾åˆ°IDä¸º ${id} çš„é€‰æ‹©å™¨ï¼Œè·³è¿‡åˆå§‹åŒ–`)
          return false
        }

        try {
          // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™é»˜è®¤é€‰é¡¹ï¼‰
          select.innerHTML = `<option value="">${defaultText}</option>`

          // æ·»åŠ æ–°é€‰é¡¹
          options.forEach((option) => {
            if (option && option.trim()) {
              // ç¡®ä¿é€‰é¡¹ä¸ä¸ºç©º
              const optionElement = document.createElement("option")
              optionElement.value = option
              optionElement.textContent = option
              select.appendChild(optionElement)
            }
          })

          console.log(`${id} é€‰æ‹©å™¨å·²æ›´æ–°ï¼Œå…± ${options.length} ä¸ªé€‰é¡¹`)
          return true
        } catch (error) {
          console.error(`æ›´æ–°é€‰æ‹©å™¨ ${id} æ—¶å‡ºé”™:`, error)
          return false
        }
      }

      // å¡«å……ä¸‹æ‹‰é€‰é¡¹ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
      function populateSelect(id, options) {
        clearAndPopulateSelect(id, options)
      }

      // æ—¶é—´æ®µç­›é€‰åŠŸèƒ½
      function applyTimeSlotFilter(timeSlot) {
        // æ¸…é™¤å…¶ä»–æ—¶é—´æ®µçš„é€‰ä¸­çŠ¶æ€
        document.querySelectorAll(".time-slot-btn").forEach((btn) => {
          btn.classList.remove("active")
        })

        // è®¾ç½®å½“å‰é€‰ä¸­çš„æ—¶é—´æ®µ
        if (timeSlot !== "all") {
          document
            .querySelector(`[data-time-slot="${timeSlot}"]`)
            .classList.add("active")
        }

        // åº”ç”¨ç­›é€‰
        applyFilters()
      }

      // æ—¶é—´åˆç†æ€§éªŒè¯ï¼šè¿”ç¨‹æ—¶é—´åº”æ™šäºå»ç¨‹æ—¶é—´
      function isValidReturnTime(outboundFlight, returnFlight) {
        try {
          // è§£ææ—¶é—´å­—ç¬¦ä¸² (æ ¼å¼: "HH:MM")
          const parseTime = (timeStr) => {
            const [hours, minutes] = timeStr.split(":").map(Number)
            return hours * 60 + minutes // è½¬æ¢ä¸ºåˆ†é’Ÿæ•°ä¾¿äºæ¯”è¾ƒ
          }

          const outboundDeparture = parseTime(outboundFlight.departure_time)
          const outboundArrival = parseTime(outboundFlight.arrival_time)
          const returnDeparture = parseTime(returnFlight.departure_time)

          // åŸºæœ¬è§„åˆ™ï¼šè¿”ç¨‹å‡ºå‘æ—¶é—´åº”è¯¥æ™šäºå»ç¨‹åˆ°è¾¾æ—¶é—´
          // è€ƒè™‘è·¨å¤©æƒ…å†µï¼šå¦‚æœå»ç¨‹åˆ°è¾¾æ—¶é—´å°äºå‡ºå‘æ—¶é—´ï¼Œè¯´æ˜è·¨å¤©äº†
          if (outboundArrival < outboundDeparture) {
            // å»ç¨‹è·¨å¤©ï¼Œè¿”ç¨‹åº”è¯¥åœ¨ç¬¬äºŒå¤©æˆ–æ›´æ™š
            return (
              returnDeparture >= outboundArrival ||
              returnDeparture >= outboundDeparture
            )
          } else {
            // å»ç¨‹ä¸è·¨å¤©ï¼Œè¿”ç¨‹åº”è¯¥æ™šäºå»ç¨‹åˆ°è¾¾æ—¶é—´
            return returnDeparture >= outboundArrival
          }
        } catch (error) {
          console.warn("æ—¶é—´è§£æé”™è¯¯:", error)
          return true // è§£æå¤±è´¥æ—¶ä¸è¿‡æ»¤
        }
      }

      // æ™ºèƒ½èˆªç­é…å¯¹ç®—æ³•ï¼šè€ƒè™‘èˆªç©ºå…¬å¸ã€æ—¶é—´é—´éš”ç­‰å› ç´ 
      function isGoodFlightPair(outboundFlight, returnFlight) {
        try {
          // 1. åŸºç¡€æ—¶é—´éªŒè¯
          if (!isValidReturnTime(outboundFlight, returnFlight)) {
            return false
          }

          // 2. èˆªç©ºå…¬å¸åŒ¹é…åŠ åˆ†ï¼ˆåŒä¸€èˆªç©ºå…¬å¸æ›´å¥½ï¼‰
          const sameAirline = outboundFlight.airline === returnFlight.airline

          // 3. æ—¶é—´é—´éš”åˆç†æ€§æ£€æŸ¥
          const parseTime = (timeStr) => {
            const [hours, minutes] = timeStr.split(":").map(Number)
            return hours * 60 + minutes
          }

          const outboundArrival = parseTime(outboundFlight.arrival_time)
          const returnDeparture = parseTime(returnFlight.departure_time)

          // è®¡ç®—é—´éš”æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
          let interval = returnDeparture - outboundArrival
          if (interval < 0) interval += 24 * 60 // å¤„ç†è·¨å¤©æƒ…å†µ

          // 4. åˆç†çš„è½¬æœºæ—¶é—´ï¼šè‡³å°‘2å°æ—¶ï¼Œæœ€å¤š24å°æ—¶æ¯”è¾ƒç†æƒ³
          const minInterval = 120 // 2å°æ—¶
          const idealMaxInterval = 24 * 60 // 24å°æ—¶

          const hasReasonableInterval =
            interval >= minInterval && interval <= idealMaxInterval

          // 5. ç»¼åˆè¯„åˆ†ï¼šåŒèˆªç©ºå…¬å¸ä¸”æ—¶é—´é—´éš”åˆç†çš„ä¼˜å…ˆ
          return (
            hasReasonableInterval && (sameAirline || interval >= minInterval)
          )
        } catch (error) {
          console.warn("èˆªç­é…å¯¹ç®—æ³•é”™è¯¯:", error)
          return true // ç®—æ³•å¤±è´¥æ—¶ä¸è¿‡æ»¤
        }
      }

      // ç­›é€‰ç»“æœç¼“å­˜
      let filterCache = new Map()
      let lastFilterHash = ""

      // ç”Ÿæˆç­›é€‰æ¡ä»¶å“ˆå¸Œå€¼
      function generateFilterHash(filters) {
        return JSON.stringify(filters)
      }

      // è¡Œç¨‹ç±»å‹ç­›é€‰å¤„ç†å‡½æ•°
      function applyTripTypeFilter(flights, tripType) {
        if (tripType === "å•ç¨‹") {
          // å•ç¨‹ï¼šæ ¹æ®å‡ºå‘åœ°å’Œç›®çš„åœ°è¿›è¡Œç­›é€‰
          return flights.filter((flight) => {
            // å¦‚æœè®¾ç½®äº†å‡ºå‘åœ°ç­›é€‰æ¡ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦åŒ¹é…
            if (filters.departure && flight.departure !== filters.departure) {
              return false
            }
            // å¦‚æœè®¾ç½®äº†ç›®çš„åœ°ç­›é€‰æ¡ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦åŒ¹é…
            if (
              filters.destination &&
              flight.destination !== filters.destination
            ) {
              return false
            }
            return true
          })
        } else if (tripType === "å¾€è¿”") {
          // å¾€è¿”ï¼šæ‰¾åˆ°æ‰€æœ‰å¯ä»¥ç»„æˆå¾€è¿”çš„èˆªç­å¯¹
          const roundtripFlights = []
          const processedFlights = new Set()

          flights.forEach((outboundFlight) => {
            if (processedFlights.has(outboundFlight.flight_number)) return

            // æŸ¥æ‰¾å¯¹åº”çš„è¿”ç¨‹èˆªç­
            const returnFlights = flights.filter(
              (returnFlight) =>
                returnFlight.departure === outboundFlight.destination &&
                returnFlight.destination === outboundFlight.departure &&
                returnFlight.flight_number !== outboundFlight.flight_number &&
                isValidReturnTime(outboundFlight, returnFlight)
            )

            if (returnFlights.length > 0) {
              // æ·»åŠ å»ç¨‹èˆªç­ï¼ˆæ ‡è®°ä¸ºå»ç¨‹ï¼‰
              const outbound = { ...outboundFlight, tripDirection: "å»ç¨‹" }
              roundtripFlights.push(outbound)
              processedFlights.add(outboundFlight.flight_number)

              // æ·»åŠ æœ€ä½³è¿”ç¨‹èˆªç­ï¼ˆæ ‡è®°ä¸ºè¿”ç¨‹ï¼‰
              const bestReturn = returnFlights[0]
              const returnFlight = { ...bestReturn, tripDirection: "è¿”ç¨‹" }
              roundtripFlights.push(returnFlight)
              processedFlights.add(bestReturn.flight_number)
            }
          })

          console.log(
            `å¾€è¿”ç­›é€‰ï¼šæ‰¾åˆ° ${roundtripFlights.length / 2} ä¸ªå¾€è¿”è¡Œç¨‹å¯¹ï¼Œå…± ${
              roundtripFlights.length
            } ä¸ªèˆªç­`
          )
          return roundtripFlights
        }

        return flights
      }

      // åº”ç”¨ç­›é€‰
      function applyFilters() {
        // å®‰å…¨è·å–DOMå…ƒç´ å€¼çš„è¾…åŠ©å‡½æ•°
        const safeGetValue = (id, defaultValue = "") => {
          const element = document.getElementById(id)
          return element ? element.value : defaultValue
        }

        const safeGetChecked = (id, defaultValue = false) => {
          const element = document.getElementById(id)
          return element ? element.checked : defaultValue
        }

        // æ›´æ–°å…¨å±€ç­›é€‰æ¡ä»¶å¯¹è±¡
        filters = {
          airline: safeGetValue("airline"),
          departure: safeGetValue("departure"),
          destination: safeGetValue("destination"),
          departureProvince: safeGetValue("departureProvince"),
          destinationProvince: safeGetValue("destinationProvince"),
          flightNumber: safeGetValue("flightNumber").toUpperCase(),
          productType: "", // äº§å“ç±»å‹é€šè¿‡2666å¯ç”¨æŒ‰é’®å¤„ç†
          nightFlight: safeGetChecked("nightFlight"),
          dayFlight: safeGetChecked("dayFlight"),
          departureTime: safeGetValue("departureTime"),
          operatingDays: Array.from(
            document.querySelectorAll(".day-checkbox:checked")
          ).map((cb) => cb.value),
          timeSlot:
            document.querySelector(".time-slot-btn.active")?.dataset.timeSlot ||
            "all",
          // æ–°çš„ç­›é€‰æ¡ä»¶
          quickTimeFilter:
            document.querySelector(".time-filter-btn.active")?.textContent ||
            "å…¨éƒ¨æ—¶æ®µ",
          tripType:
            document.querySelector(".trip-type-btn.active")?.textContent ||
            "å•ç¨‹",
          available2666:
            document
              .getElementById("available2666")
              ?.classList.contains("active") || false,
          segment: safeGetValue("segmentSelect", "all")
        }

        // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºå½“å‰ç­›é€‰æ¡ä»¶
        console.log("=== ç­›é€‰æ¡ä»¶è°ƒè¯•ä¿¡æ¯ ===")
        console.log("ç­›é€‰æ¡ä»¶:", filters)
        console.log("åŸå§‹æ•°æ®æ€»æ•°:", flightData.length)

        // æ€§èƒ½ä¼˜åŒ–ï¼šæ£€æŸ¥ç­›é€‰æ¡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        const currentFilterHash = generateFilterHash(filters)
        if (
          currentFilterHash === lastFilterHash &&
          filterCache.has(currentFilterHash)
        ) {
          // ä½¿ç”¨ç¼“å­˜ç»“æœ
          filteredData = filterCache.get(currentFilterHash)
          originalFilteredData = [...filteredData]
          console.log("ä½¿ç”¨ç¼“å­˜ç»“æœï¼Œç­›é€‰åæ•°æ®:", filteredData.length, "æ¡")
          displayResults()
          return
        }

        // è®°å½•å½“å‰ç­›é€‰æ¡ä»¶å“ˆå¸Œ
        lastFilterHash = currentFilterHash

        filteredData = flightData.filter((flight) => {
          // åŸºç¡€ç­›é€‰
          if (filters.airline && flight.airline !== filters.airline)
            return false
          if (filters.departure && flight.departure !== filters.departure)
            return false
          if (filters.destination && flight.destination !== filters.destination)
            return false
          if (
            filters.departureProvince &&
            flight.departure_province !== filters.departureProvince
          )
            return false
          if (
            filters.destinationProvince &&
            flight.destination_province !== filters.destinationProvince
          )
            return false
          if (
            filters.flightNumber &&
            !flight.flight_number.includes(filters.flightNumber)
          )
            return false
          // äº§å“ç±»å‹ç­›é€‰å·²é€šè¿‡2666å¯ç”¨æŒ‰é’®å¤„ç†

          // èˆªç­ç±»å‹ç­›é€‰
          if (filters.nightFlight && !flight.is_night) return false
          if (filters.dayFlight && flight.is_night) return false

          // èµ·é£æ—¶é—´ç­›é€‰
          if (filters.departureTime) {
            const hour = parseInt(flight.departure_time.split(":")[0])
            switch (filters.departureTime) {
              case "early":
                if (hour >= 6) return false
                break
              case "morning":
                if (hour < 6 || hour >= 12) return false
                break
              case "afternoon":
                if (hour < 12 || hour >= 18) return false
                break
              case "evening":
                if (hour < 18) return false
                break
            }
          }

          // æ—¶é—´æ®µç­›é€‰
          if (filters.timeSlot && filters.timeSlot !== "all") {
            const hour = parseInt(flight.departure_time.split(":")[0])
            switch (filters.timeSlot) {
              case "dawn":
                if (hour < 0 || hour >= 8) return false
                break
              case "morning":
                if (hour < 8 || hour >= 12) return false
                break
              case "afternoon":
                if (hour < 12 || hour >= 18) return false
                break
              case "evening":
                if (hour < 18 || hour >= 20) return false
                break
              case "night":
                if (hour < 20 && hour >= 8) return false
                break
            }
          }

          // å¿«æ·æ—¶é—´æ®µç­›é€‰
          if (
            filters.quickTimeFilter &&
            filters.quickTimeFilter !== "å…¨éƒ¨æ—¶æ®µ"
          ) {
            const hour = parseInt(flight.departure_time.split(":")[0])
            switch (filters.quickTimeFilter) {
              case "å‡Œæ™¨":
                if (hour < 0 || hour >= 6) return false
                break
              case "æ™šä¸Š":
                if (hour < 18 || hour >= 24) return false
                break
            }
          }

          // 2666å¯ç”¨çŠ¶æ€ç­›é€‰
          if (filters.available2666) {
            // æ£€æŸ¥product_typeå­—æ®µæ˜¯å¦åŒ…å«2666
            if (!flight.product_type || !flight.product_type.includes("2666"))
              return false
          }

          // èˆªæ®µç­›é€‰ - æ•°æ®ä¸­æš‚æ— segmentå­—æ®µï¼Œè·³è¿‡æ­¤ç­›é€‰
          // if (filters.segment && filters.segment !== "all") {
          //   if (flight.segment !== filters.segment) return false
          // }

          // è¿è¥æ—¥æœŸç­›é€‰
          if (filters.operatingDays.length > 0) {
            const hasMatchingDay = filters.operatingDays.some((day) =>
              flight.days.includes(day)
            )
            if (!hasMatchingDay) return false
          }

          // è¡Œç¨‹ç±»å‹ç­›é€‰ - æš‚æ—¶è·³è¿‡ï¼Œåœ¨åé¢å•ç‹¬å¤„ç†
          // è¿™é‡Œåªè¿›è¡ŒåŸºç¡€ç­›é€‰ï¼Œè¡Œç¨‹ç±»å‹ç­›é€‰éœ€è¦ç‰¹æ®Šå¤„ç†

          return true
        })

        // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºç­›é€‰ç»“æœ
        console.log("ç­›é€‰åæ•°æ®:", filteredData.length, "æ¡")
        console.log(
          "ç­›é€‰é€šè¿‡ç‡:",
          ((filteredData.length / flightData.length) * 100).toFixed(1) + "%"
        )
        if (filteredData.length === 0) {
          console.warn("âš ï¸ ç­›é€‰ç»“æœä¸ºç©ºï¼Œè¯·æ£€æŸ¥ç­›é€‰æ¡ä»¶æ˜¯å¦è¿‡äºä¸¥æ ¼")
        }
        console.log("=== ç­›é€‰è°ƒè¯•ä¿¡æ¯ç»“æŸ ===")

        // ç¼“å­˜ç­›é€‰ç»“æœï¼ˆé™åˆ¶ç¼“å­˜å¤§å°é¿å…å†…å­˜æ³„æ¼ï¼‰
        if (filterCache.size > 50) {
          // æ¸…ç†æœ€æ—§çš„ç¼“å­˜é¡¹
          const firstKey = filterCache.keys().next().value
          filterCache.delete(firstKey)
        }
        filterCache.set(currentFilterHash, [...filteredData])

        // ä¿å­˜åŸå§‹ç­›é€‰ç»“æœ
        originalFilteredData = [...filteredData]

        // è¡Œç¨‹ç±»å‹ç­›é€‰å¤„ç†
        if (filters.tripType) {
          filteredData = applyTripTypeFilter(filteredData, filters.tripType)
        }

        // å¦‚æœæœ‰åŸå¸‚æœç´¢ï¼Œåº”ç”¨åŸå¸‚ç­›é€‰
        const departureCity = safeGetValue("departureCity").trim()
        const destinationCity = safeGetValue("destinationCity").trim()
        if (departureCity || destinationCity) {
          performCitySearch()
        } else {
          displayResults()
        }
      }

      // é‡ç½®ç­›é€‰
      function resetFilters() {
        // å®‰å…¨é‡ç½®è¡¨å•å…ƒç´ 
        const safeReset = (id, value = "") => {
          const element = document.getElementById(id)
          if (element) element.value = value
        }

        const safeSetChecked = (id, checked = false) => {
          const element = document.getElementById(id)
          if (element) element.checked = checked
        }

        safeReset("airline")
        safeReset("departure")
        safeReset("destination")
        safeReset("departureProvince")
        safeReset("destinationProvince")
        safeReset("flightNumber")
        safeSetChecked("nightFlight")
        safeSetChecked("dayFlight")
        safeReset("departureTime")

        document
          .querySelectorAll(".day-checkbox")
          .forEach((cb) => (cb.checked = false))

        // æ¸…ç©ºåŸå¸‚æœç´¢
        safeReset("departureCity")
        safeReset("destinationCity")

        // é‡ç½®è¡Œç¨‹ç±»å‹
        document.querySelectorAll(".trip-type-btn").forEach((btn) => {
          btn.classList.remove("active")
        })
        const roundtripBtn = document.querySelector('[data-trip="roundtrip"]')
        if (roundtripBtn) roundtripBtn.classList.add("active")

        // é‡ç½®æ—¶é—´æ®µç­›é€‰
        document.querySelectorAll(".time-filter-btn").forEach((btn) => {
          btn.classList.remove("active")
        })
        const allTimeBtn = document.querySelector('[data-time="all"]')
        if (allTimeBtn) allTimeBtn.classList.add("active")

        // é‡ç½®2666å¯ç”¨çŠ¶æ€
        const available2666 = document.getElementById("available2666")
        if (available2666) available2666.classList.remove("active")

        // é‡ç½®èˆªæ®µé€‰æ‹©
        safeReset("segmentSelect", "all")

        document.getElementById("searchResultsInfo").innerHTML = `
          <div class="flex items-center gap-4 text-sm text-gray-600 bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 rounded-xl border border-blue-100 shadow-sm">
            <i class="iconfont icon-tips text-blue-500 text-xl animate-pulse"></i>
            <span class="font-medium">é€‰æ‹©å‡ºå‘åŸå¸‚å’Œç›®çš„åœ°åŸå¸‚ï¼Œä½¿ç”¨ç­›é€‰æ¡ä»¶ç²¾ç¡®æŸ¥æ‰¾èˆªç­ Â· æ”¯æŒæ—¶é—´æ®µã€è¡Œç¨‹ç±»å‹å’Œèˆªæ®µç­›é€‰</span>
          </div>
        `

        // é‡ç½®åé‡æ–°åº”ç”¨ç­›é€‰æ¡ä»¶
        console.log("ğŸ”„ é‡ç½®ç­›é€‰æ¡ä»¶ï¼Œé‡æ–°åº”ç”¨ç­›é€‰")
        applyFilters()
      }

      // æ˜¾ç¤ºç»“æœ
      function displayResults() {
        const tbody = document.getElementById("flightTableBody")

        if (filteredData.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="9" class="px-6 py-12 text-center text-gray-500"><i class="iconfont icon-empty text-3xl mb-2 block"></i>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„èˆªç­</td></tr>'
        } else {
          tbody.innerHTML = filteredData
            .map(
              (flight) => `
                    <tr class="hover:bg-gray-50 transition-colors duration-200 ${
                      flight.is_night ? "night-flight" : ""
                    }">
                        <td class="px-6 py-4 text-sm text-gray-900 font-medium">
                          <div class="flex items-center gap-2">
                            <i class="iconfont icon-airplane text-blue-500"></i>
                            <span>${flight.airline}</span>
                            ${
                              flight.tripDirection
                                ? `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium ${
                                    flight.tripDirection === "å»ç¨‹"
                                      ? "bg-green-100 text-green-700"
                                      : "bg-blue-100 text-blue-700"
                                  }">${flight.tripDirection}</span>`
                                : ""
                            }
                          </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900 font-mono font-semibold">${
                          flight.flight_number
                        }</td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                          <i class="iconfont icon-departure text-green-500 mr-1"></i>${highlightMatchedCity(
                            flight.departure,
                            "departure"
                          )}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                          <i class="iconfont icon-arrival text-red-500 mr-1"></i>${highlightMatchedCity(
                            flight.destination,
                            "destination"
                          )}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900 font-mono">
                          <i class="iconfont icon-time text-blue-500 mr-1"></i>${
                            flight.departure_time
                          }
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900 font-mono">
                          <i class="iconfont icon-time text-blue-500 mr-1"></i>${
                            flight.arrival_time
                          }
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                          <i class="iconfont icon-calendar text-purple-500 mr-1"></i>${formatOperatingDays(
                            flight.days
                          )}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${flight.product_type}
                          </span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            flight.is_night
                              ? "bg-purple-100 text-purple-800"
                              : "bg-orange-100 text-orange-800"
                          }">
                            <i class="iconfont ${
                              flight.is_night ? "icon-moon" : "icon-sun"
                            } mr-1"></i>
                            ${flight.is_night ? "çº¢çœ¼èˆªç­" : "æ—¥é—´èˆªç­"}
                          </span>
                        </td>
                    </tr>
                `
            )
            .join("")
        }

        updateStats()
      }

      // é«˜äº®åŒ¹é…çš„åŸå¸‚åç§°
      function highlightMatchedCity(cityName, type) {
        const safeGetValue = (id, defaultValue = "") => {
          const element = document.getElementById(id)
          return element ? element.value : defaultValue
        }

        const searchValue =
          type === "departure"
            ? safeGetValue("departureCity").trim()
            : safeGetValue("destinationCity").trim()

        if (!searchValue) {
          return cityName
        }

        // å¦‚æœåŸå¸‚ååŒ…å«æœç´¢å…³é”®è¯ï¼Œåˆ™é«˜äº®æ˜¾ç¤º
        if (cityName.toLowerCase().includes(searchValue.toLowerCase())) {
          const regex = new RegExp(`(${searchValue})`, "gi")
          return cityName.replace(
            regex,
            '<span class="bg-yellow-200 text-yellow-800 px-1 rounded font-semibold">$1</span>'
          )
        }

        return cityName
      }

      // æ ¼å¼åŒ–è¿è¥æ—¥æœŸ
      function formatOperatingDays(days) {
        const dayMap = {
          1: "å‘¨ä¸€",
          2: "å‘¨äºŒ",
          3: "å‘¨ä¸‰",
          4: "å‘¨å››",
          5: "å‘¨äº”",
          6: "å‘¨å…­",
          7: "å‘¨æ—¥"
        }

        if (days === "1234567") {
          return "æ¯æ—¥"
        }

        return days
          .split("")
          .map((d) => dayMap[d])
          .join("ã€")
      }

      // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
      function updateStats() {
        const total = filteredData.length
        const nightFlights = filteredData.filter((f) => f.is_night).length
        const dayFlights = filteredData.filter((f) => !f.is_night).length
        const availableFlights = Math.floor(total * 0.75) // æ¨¡æ‹Ÿ2666å¯ç”¨èˆªç­æ•°é‡

        // å®‰å…¨æ›´æ–°ç»Ÿè®¡æ•°æ®
        const safeUpdateText = (id, value) => {
          const element = document.getElementById(id)
          if (element) element.textContent = value
        }

        safeUpdateText("totalFlights", total)
        safeUpdateText("nightFlights", nightFlights)
        safeUpdateText("dayFlights", dayFlights)
        safeUpdateText("availableFlights", availableFlights)

        // æ›´æ–°å½“å‰æ—¶æ®µæ˜¾ç¤º
        const currentHour = new Date().getHours()
        let timeSlot = "å…¨éƒ¨"
        if (currentHour >= 0 && currentHour < 6) timeSlot = "å‡Œæ™¨"
        else if (currentHour >= 6 && currentHour < 12) timeSlot = "ä¸Šåˆ"
        else if (currentHour >= 12 && currentHour < 18) timeSlot = "ä¸‹åˆ"
        else if (currentHour >= 18 && currentHour < 24) timeSlot = "æ™šé—´"

        safeUpdateText("currentTimeSlot", timeSlot)

        // æ›´æ–°ç­›é€‰çŠ¶æ€
        updateFilterStatus()
      }

      // æ›´æ–°ç­›é€‰çŠ¶æ€æ˜¾ç¤º
      function updateFilterStatus() {
        const filterStatus = document.getElementById("filterStatus")
        if (!filterStatus) {
          console.warn("æœªæ‰¾åˆ°filterStatuså…ƒç´ ")
          return
        }

        const activeFilters = []

        if (filters.airline) activeFilters.push("èˆªç©ºå…¬å¸")
        if (filters.departure) activeFilters.push("å‡ºå‘åœ°")
        if (filters.destination) activeFilters.push("åˆ°è¾¾åœ°")
        if (filters.nightFlight || filters.dayFlight)
          activeFilters.push("èˆªç­ç±»å‹")
        if (filters.timeSlot && filters.timeSlot !== "all")
          activeFilters.push("æ—¶é—´æ®µ")
        if (filters.departureTime) activeFilters.push("èµ·é£æ—¶é—´")
        if (filters.operatingDays && filters.operatingDays.length > 0)
          activeFilters.push("è¿è¥æ—¥æœŸ")
        if (filters.available2666) activeFilters.push("2666å¯ç”¨")
        if (filters.segment && filters.segment !== "all")
          activeFilters.push("èˆªæ®µ")
        if (filters.quickTimeFilter && filters.quickTimeFilter !== "å…¨éƒ¨æ—¶æ®µ")
          activeFilters.push("å¿«æ·æ—¶é—´")
        if (filters.tripType && filters.tripType !== "å•ç¨‹")
          activeFilters.push("è¡Œç¨‹ç±»å‹")

        if (activeFilters.length === 0) {
          filterStatus.innerHTML =
            '<i class="iconfont icon-filter mr-1"></i>æ— ç­›é€‰æ¡ä»¶'
          filterStatus.className =
            "inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
        } else {
          filterStatus.innerHTML = `<i class="iconfont icon-filter mr-1"></i>å·²åº”ç”¨ ${activeFilters.length} ä¸ªç­›é€‰æ¡ä»¶`
          filterStatus.className =
            "inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"
        }
      }

      // åˆ·æ–°æ•°æ®åŠŸèƒ½
      function refreshData() {
        const refreshBtn = event.target.closest("button")
        if (!refreshBtn) {
          console.warn("æœªæ‰¾åˆ°åˆ·æ–°æŒ‰é’®å…ƒç´ ")
          return
        }

        const originalText = refreshBtn.innerHTML

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        refreshBtn.innerHTML =
          '<i class="iconfont icon-loading animate-spin text-lg mr-2"></i>åˆ·æ–°ä¸­...'
        refreshBtn.disabled = true

        // æ¨¡æ‹Ÿåˆ·æ–°å»¶è¿Ÿ
        setTimeout(() => {
          loadFlightData()
          refreshBtn.innerHTML = originalText
          refreshBtn.disabled = false
        }, 1500)
      }

      // å¯¼å‡ºç»“æœ
      function exportResults() {
        const csvContent = [
          [
            "èˆªç©ºå…¬å¸",
            "èˆªç­å·",
            "å‡ºå‘åŸå¸‚",
            "åˆ°è¾¾åŸå¸‚",
            "å‡ºå‘æ—¶é—´",
            "åˆ°è¾¾æ—¶é—´",
            "è¿è¥æ—¥æœŸ",
            "äº§å“ç±»å‹",
            "èˆªç­ç±»å‹"
          ],
          ...filteredData.map((flight) => [
            flight.airline,
            flight.flight_number,
            flight.departure,
            flight.destination,
            flight.departure_time,
            flight.arrival_time,
            formatOperatingDays(flight.days),
            flight.product_type,
            flight.is_night ? "çº¢çœ¼èˆªç­" : "æ—¥é—´èˆªç­"
          ])
        ]
          .map((row) => row.join(","))
          .join("\n")

        const blob = new Blob(["\ufeff" + csvContent], {
          type: "text/csv;charset=utf-8;"
        })
        const link = document.createElement("a")
        link.href = URL.createObjectURL(blob)
        link.download = `èˆªç­æŸ¥è¯¢ç»“æœ_${new Date().toLocaleDateString()}.csv`
        link.click()
      }

      // æ–°çš„ç­›é€‰åŠŸèƒ½äº‹ä»¶å¤„ç†
      function setupNewFilters() {
        // æ—¶é—´æ®µç­›é€‰æŒ‰é’®äº‹ä»¶
        const timeFilterBtns = document.querySelectorAll(".time-filter-btn")
        if (timeFilterBtns.length > 0) {
          timeFilterBtns.forEach((btn) => {
            btn.addEventListener("click", function () {
              document
                .querySelectorAll(".time-filter-btn")
                .forEach((b) => b.classList.remove("active"))
              this.classList.add("active")
              applyFilters()
            })
          })
        }

        // è¡Œç¨‹ç±»å‹æŒ‰é’®äº‹ä»¶
        const tripTypeBtns = document.querySelectorAll(".trip-type-btn")
        if (tripTypeBtns.length > 0) {
          tripTypeBtns.forEach((btn) => {
            btn.addEventListener("click", function () {
              document
                .querySelectorAll(".trip-type-btn")
                .forEach((b) => b.classList.remove("active"))
              this.classList.add("active")
              applyFilters()
            })
          })
        }

        // 2666å¯ç”¨çŠ¶æ€æŒ‰é’®äº‹ä»¶
        const available2666Btn = document.getElementById("available2666")
        if (available2666Btn) {
          available2666Btn.addEventListener("click", function () {
            this.classList.toggle("active")
            applyFilters()
          })
        }

        // èˆªæ®µé€‰æ‹©äº‹ä»¶
        const segmentSelect = document.getElementById("segmentSelect")
        if (segmentSelect) {
          segmentSelect.addEventListener("change", function () {
            applyFilters()
          })
        }

        // åŸå¸‚æœç´¢æ¡†äº‹ä»¶
        const departureCity = document.getElementById("departureCity")
        const destinationCity = document.getElementById("destinationCity")
        if (departureCity) {
          departureCity.addEventListener("input", performCitySearch)
        }
        if (destinationCity) {
          destinationCity.addEventListener("input", performCitySearch)
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      window.onload = function () {
        // è‡ªåŠ¨åŠ è½½åœ¨çº¿æ•°æ®
        loadFlightData()

        // è®¾ç½®æ–°çš„ç­›é€‰åŠŸèƒ½äº‹ä»¶
        setupNewFilters()

        // å¤‡ç”¨ï¼šæä¾›æ–‡ä»¶è¾“å…¥æ¡†è®©ç”¨æˆ·é€‰æ‹©æœ¬åœ°æ–‡ä»¶
        const fileInput = document.createElement("input")
        fileInput.type = "file"
        fileInput.accept = ".json"
        fileInput.style.display = "none"
        fileInput.onchange = function (e) {
          const file = e.target.files[0]
          if (file) {
            const reader = new FileReader()
            reader.onload = function (e) {
              try {
                const data = JSON.parse(e.target.result)
                flightData = data.flights
                initializeFilters()
                applyFilters()
              } catch (error) {
                alert("æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é€‰æ‹©æ­£ç¡®çš„JSONæ–‡ä»¶")
              }
            }
            reader.readAsText(file)
          }
        }
        document.body.appendChild(fileInput)
      }

      // æ–°çš„åŸå¸‚æœç´¢åŠŸèƒ½
      function performCitySearch() {
        const safeGetValue = (id, defaultValue = "") => {
          const element = document.getElementById(id)
          return element ? element.value : defaultValue
        }

        const departureCity = safeGetValue("departureCity").trim().toLowerCase()
        const destinationCity = safeGetValue("destinationCity")
          .trim()
          .toLowerCase()
        const searchResultsInfo = document.getElementById("searchResultsInfo")

        if (!departureCity && !destinationCity) {
          // å¦‚æœæœç´¢æ¡†éƒ½ä¸ºç©ºï¼Œæ˜¾ç¤ºåŸå§‹ç­›é€‰ç»“æœ
          filteredData = [...originalFilteredData]
          searchResultsInfo.innerHTML = `
            <div class="flex items-center gap-4 text-sm text-gray-600 bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 rounded-xl border border-blue-100 shadow-sm">
              <i class="iconfont icon-tips text-blue-500 text-xl animate-pulse"></i>
              <span class="font-medium">é€‰æ‹©å‡ºå‘åŸå¸‚å’Œç›®çš„åœ°åŸå¸‚ï¼Œä½¿ç”¨ç­›é€‰æ¡ä»¶ç²¾ç¡®æŸ¥æ‰¾èˆªç­ Â· æ”¯æŒæ—¶é—´æ®µã€è¡Œç¨‹ç±»å‹å’Œèˆªæ®µç­›é€‰</span>
            </div>
          `
          displayResults()
          return
        }

        // åœ¨åŸå§‹ç­›é€‰ç»“æœä¸­è¿›è¡ŒåŸå¸‚æœç´¢
        const cityFilteredData = originalFilteredData.filter((flight) => {
          let departureMatch = true
          let destinationMatch = true

          if (departureCity) {
            departureMatch =
              flight.departure.toLowerCase().includes(departureCity) ||
              flight.departure_province.toLowerCase().includes(departureCity)
          }

          if (destinationCity) {
            destinationMatch =
              flight.destination.toLowerCase().includes(destinationCity) ||
              flight.destination_province
                .toLowerCase()
                .includes(destinationCity)
          }

          return departureMatch && destinationMatch
        })

        filteredData = cityFilteredData

        // æ›´æ–°æœç´¢ç»“æœä¿¡æ¯
        if (cityFilteredData.length > 0) {
          let searchInfo = []
          if (departureCity) searchInfo.push(`å‡ºå‘: ${departureCity}`)
          if (destinationCity) searchInfo.push(`ç›®çš„åœ°: ${destinationCity}`)

          searchResultsInfo.innerHTML = `
            <div class="flex items-center gap-4 text-sm text-gray-600 bg-gradient-to-r from-green-50 to-emerald-50 px-6 py-4 rounded-xl border border-green-100 shadow-sm">
              <i class="iconfont icon-success text-green-500 text-xl"></i>
              <span class="font-medium">ğŸ” æœç´¢æ¡ä»¶: ${searchInfo.join(
                " â†’ "
              )} | æ‰¾åˆ° ${cityFilteredData.length} ä¸ªèˆªç­</span>
            </div>
          `
        } else {
          let searchInfo = []
          if (departureCity) searchInfo.push(`å‡ºå‘: ${departureCity}`)
          if (destinationCity) searchInfo.push(`ç›®çš„åœ°: ${destinationCity}`)

          searchResultsInfo.innerHTML = `
            <div class="flex items-center gap-4 text-sm text-gray-600 bg-gradient-to-r from-red-50 to-pink-50 px-6 py-4 rounded-xl border border-red-100 shadow-sm">
              <i class="iconfont icon-warning text-red-500 text-xl"></i>
              <span class="font-medium">ğŸ” æœç´¢æ¡ä»¶: ${searchInfo.join(
                " â†’ "
              )} | æœªæ‰¾åˆ°ç›¸å…³èˆªç­ï¼Œè¯·å°è¯•å…¶ä»–åŸå¸‚</span>
            </div>
          `
        }

        displayResults()
      }

      // æ¸…ç©ºåŸå¸‚æœç´¢
      function clearCitySearch() {
        const safeReset = (id, value = "") => {
          const element = document.getElementById(id)
          if (element) element.value = value
        }

        safeReset("departureCity")
        safeReset("destinationCity")

        // å®‰å…¨æ›´æ–°æœç´¢ç»“æœä¿¡æ¯
        const searchResultsInfo = document.getElementById("searchResultsInfo")
        if (searchResultsInfo) {
          searchResultsInfo.innerHTML = `
            <div class="flex items-center gap-4 text-sm text-gray-600 bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 rounded-xl border border-blue-100 shadow-sm">
              <i class="iconfont icon-tips text-blue-500 text-xl animate-pulse"></i>
              <span class="font-medium">é€‰æ‹©å‡ºå‘åŸå¸‚å’Œç›®çš„åœ°åŸå¸‚ï¼Œä½¿ç”¨ç­›é€‰æ¡ä»¶ç²¾ç¡®æŸ¥æ‰¾èˆªç­ Â· æ”¯æŒæ—¶é—´æ®µã€è¡Œç¨‹ç±»å‹å’Œèˆªæ®µç­›é€‰</span>
            </div>
          `
        }

        // æ¢å¤åˆ°åŸå§‹ç­›é€‰ç»“æœ
        filteredData = [...originalFilteredData]
        displayResults()
      }

      // å‡ºå‘åŸå¸‚æœç´¢åŠŸèƒ½
      function performDepartureSearch() {
        const departureInput = document.getElementById("departureSearch")
        if (!departureInput) return

        const searchValue = departureInput.value.trim().toLowerCase()
        performCitySearch()
      }

      // ç›®çš„åœ°åŸå¸‚æœç´¢åŠŸèƒ½
      function performDestinationSearch() {
        const destinationInput = document.getElementById("destinationSearch")
        if (!destinationInput) return

        const searchValue = destinationInput.value.trim().toLowerCase()
        performCitySearch()
      }

      // æ¸…ç©ºå‡ºå‘åŸå¸‚æœç´¢
      function clearDepartureSearch() {
        const departureInput = document.getElementById("departureSearch")
        if (departureInput) {
          departureInput.value = ""
          performCitySearch()
        }
      }

      // æ¸…ç©ºç›®çš„åœ°åŸå¸‚æœç´¢
      function clearDestinationSearch() {
        const destinationInput = document.getElementById("destinationSearch")
        if (destinationInput) {
          destinationInput.value = ""
          performCitySearch()
        }
      }

      // è¡Œç¨‹ç±»å‹é€‰æ‹©åŠŸèƒ½
      function selectTripType(type) {
        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
        document.querySelectorAll(".trip-type-btn").forEach((btn) => {
          btn.classList.remove("active")
          btn.classList.remove("bg-blue-500", "text-white", "border-blue-500")
          btn.classList.add("border-gray-300", "text-gray-700")
        })

        // ä¸ºå½“å‰é€‰ä¸­çš„æŒ‰é’®æ·»åŠ activeçŠ¶æ€
        const selectedBtn = document.querySelector(`[data-type="${type}"]`)
        if (selectedBtn) {
          selectedBtn.classList.add("active")
          selectedBtn.classList.remove("border-gray-300", "text-gray-700")
          selectedBtn.classList.add(
            "bg-blue-500",
            "text-white",
            "border-blue-500"
          )
        }

        // æ›´æ–°ç­›é€‰æ¡ä»¶
        filters.tripType = type === "round-trip" ? "å¾€è¿”" : "å•ç¨‹"

        // åº”ç”¨ç­›é€‰
        applyFilters()
      }

      // æ—¶é—´ç­›é€‰åŠŸèƒ½
      function selectTimeFilter(timeType) {
        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
        document.querySelectorAll(".time-filter-btn").forEach((btn) => {
          btn.classList.remove("active")
          btn.classList.remove("bg-blue-500", "text-white")
          btn.classList.add("border-gray-300", "text-gray-700")
        })

        // ä¸ºå½“å‰é€‰ä¸­çš„æŒ‰é’®æ·»åŠ activeçŠ¶æ€
        const selectedBtn = document.querySelector(`[data-time="${timeType}"]`)
        if (selectedBtn) {
          selectedBtn.classList.add("active")
          selectedBtn.classList.remove("border-gray-300", "text-gray-700")
          selectedBtn.classList.add("bg-blue-500", "text-white")
        }

        // æ›´æ–°ç­›é€‰æ¡ä»¶
        filters.quickTimeFilter =
          timeType === "all"
            ? "å…¨éƒ¨æ—¶æ®µ"
            : timeType === "night"
            ? "æ™šä¸Š"
            : timeType === "early"
            ? "å‡Œæ™¨"
            : "å…¨éƒ¨æ—¶æ®µ"

        // åº”ç”¨ç­›é€‰
        applyFilters()
      }

      // å¯ç”¨æ€§ç­›é€‰åˆ‡æ¢
      function toggleAvailabilityFilter(type) {
        const btn = document.querySelector(`[data-availability="${type}"]`)
        if (!btn) return

        if (btn.classList.contains("active")) {
          btn.classList.remove("active", "bg-green-500", "text-white")
          btn.classList.add("border-green-300", "text-green-700")
          filters.available2666 = false
        } else {
          btn.classList.add("active", "bg-green-500", "text-white")
          btn.classList.remove("border-green-300", "text-green-700")
          filters.available2666 = true
        }

        // åº”ç”¨ç­›é€‰
        applyFilters()
      }

      // èˆªæ®µç­›é€‰åŠŸèƒ½
      function selectSegmentFilter(segment) {
        filters.segment = segment || "all"
        applyFilters()
      }

      // åŸå¸‚æœç´¢åŠŸèƒ½ï¼ˆç»Ÿä¸€å¤„ç†å‡ºå‘å’Œç›®çš„åœ°æœç´¢ï¼‰
      function performCitySearch() {
        const departureInput = document.getElementById("departureSearch")
        const destinationInput = document.getElementById("destinationSearch")
        const searchResultsInfo = document.getElementById("searchResultsInfo")

        if (!departureInput || !destinationInput || !searchResultsInfo) {
          console.warn("æœç´¢ç›¸å…³DOMå…ƒç´ æœªæ‰¾åˆ°")
          return
        }

        const departureCity = departureInput.value.trim().toLowerCase()
        const destinationCity = destinationInput.value.trim().toLowerCase()

        // å¦‚æœæ²¡æœ‰æœç´¢æ¡ä»¶ï¼Œæ˜¾ç¤ºé»˜è®¤æç¤º
        if (!departureCity && !destinationCity) {
          searchResultsInfo.innerHTML = `
            <div class="flex items-center gap-4 text-sm text-gray-600 bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 rounded-xl border border-blue-100 shadow-sm">
              <i class="iconfont icon-tips text-blue-500 text-xl animate-pulse"></i>
              <span class="font-medium">é€‰æ‹©å‡ºå‘åŸå¸‚å’Œç›®çš„åœ°åŸå¸‚ï¼Œä½¿ç”¨ç­›é€‰æ¡ä»¶ç²¾ç¡®æŸ¥æ‰¾èˆªç­ Â· æ”¯æŒæ—¶é—´æ®µã€è¡Œç¨‹ç±»å‹å’Œèˆªæ®µç­›é€‰</span>
            </div>
          `
          filteredData = [...originalFilteredData]
          displayResults()
          return
        }

        // åœ¨åŸå§‹ç­›é€‰ç»“æœä¸­è¿›è¡ŒåŸå¸‚æœç´¢
        const cityFilteredData = originalFilteredData.filter((flight) => {
          let departureMatch = true
          let destinationMatch = true

          if (departureCity) {
            departureMatch =
              flight.departure.toLowerCase().includes(departureCity) ||
              flight.departure_province.toLowerCase().includes(departureCity)
          }

          if (destinationCity) {
            destinationMatch =
              flight.destination.toLowerCase().includes(destinationCity) ||
              flight.destination_province
                .toLowerCase()
                .includes(destinationCity)
          }

          return departureMatch && destinationMatch
        })

        filteredData = cityFilteredData

        // æ›´æ–°æœç´¢ç»“æœä¿¡æ¯
        if (cityFilteredData.length > 0) {
          let searchInfo = []
          if (departureCity) searchInfo.push(`å‡ºå‘: ${departureCity}`)
          if (destinationCity) searchInfo.push(`ç›®çš„åœ°: ${destinationCity}`)

          searchResultsInfo.innerHTML = `
            <div class="flex items-center gap-4 text-sm text-gray-600 bg-gradient-to-r from-green-50 to-emerald-50 px-6 py-4 rounded-xl border border-green-100 shadow-sm">
              <i class="iconfont icon-success text-green-500 text-xl"></i>
              <span class="font-medium">ğŸ” æœç´¢æ¡ä»¶: ${searchInfo.join(
                " â†’ "
              )} | æ‰¾åˆ° ${cityFilteredData.length} ä¸ªèˆªç­</span>
            </div>
          `
        } else {
          let searchInfo = []
          if (departureCity) searchInfo.push(`å‡ºå‘: ${departureCity}`)
          if (destinationCity) searchInfo.push(`ç›®çš„åœ°: ${destinationCity}`)

          searchResultsInfo.innerHTML = `
            <div class="flex items-center gap-4 text-sm text-gray-600 bg-gradient-to-r from-red-50 to-pink-50 px-6 py-4 rounded-xl border border-red-100 shadow-sm">
              <i class="iconfont icon-warning text-red-500 text-xl"></i>
              <span class="font-medium">ğŸ” æœç´¢æ¡ä»¶: ${searchInfo.join(
                " â†’ "
              )} | æœªæ‰¾åˆ°ç›¸å…³èˆªç­ï¼Œè¯·å°è¯•å…¶ä»–åŸå¸‚</span>
            </div>
          `
        }

        displayResults()
      }

      // åˆ‡æ¢è¯¦ç»†æœç´¢é¢æ¿
      function toggleAdvancedSearch() {
        const filtersPanel = document.getElementById("advancedFilters")
        const toggleBtn = document.getElementById("toggleBtn")
        const toggleText = document.getElementById("toggleText")
        const toggleIcon = document.getElementById("toggleIcon")

        // æ£€æŸ¥DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
        if (!filtersPanel) {
          console.warn("æœªæ‰¾åˆ°advancedFilterså…ƒç´ ")
          return
        }

        if (
          filtersPanel.style.display === "none" ||
          !filtersPanel.style.display
        ) {
          // æ˜¾ç¤ºç­›é€‰é¢æ¿
          filtersPanel.style.display = "block"
          filtersPanel.classList.remove("hide")
          filtersPanel.classList.add("show")

          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          if (toggleText) toggleText.textContent = "æ”¶èµ·ç­›é€‰"
          if (toggleBtn) toggleBtn.classList.add("expanded")
          if (toggleIcon) toggleIcon.textContent = "â–²"
        } else {
          // éšè—ç­›é€‰é¢æ¿
          filtersPanel.classList.remove("show")
          filtersPanel.classList.add("hide")

          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          if (toggleText) toggleText.textContent = "è¯¦ç»†æœç´¢"
          if (toggleBtn) toggleBtn.classList.remove("expanded")
          if (toggleIcon) toggleIcon.textContent = "â–¼"

          // å»¶è¿Ÿéšè—ä»¥ç­‰å¾…åŠ¨ç”»å®Œæˆ
          setTimeout(() => {
            if (filtersPanel.classList.contains("hide")) {
              filtersPanel.style.display = "none"
              filtersPanel.classList.remove("hide")
            }
          }, 400)
        }
      }

      // åŸå¸‚ä¸‹æ‹‰é€‰æ‹©åŠŸèƒ½
      let allCities = new Set()
      let currentFocusedInput = null
      let selectedIndex = -1

      // åˆå§‹åŒ–åŸå¸‚æ•°æ®
      function initializeCityData() {
        allCities.clear()
        if (flightData && flightData.length > 0) {
          flightData.forEach((flight) => {
            allCities.add(flight.departure)
            allCities.add(flight.destination)
          })
        }
      }

      // æ˜¾ç¤ºåŸå¸‚ä¸‹æ‹‰åˆ—è¡¨
      function showCityDropdown(inputId, cities) {
        const dropdownId = inputId + "Dropdown"
        const dropdown = document.getElementById(dropdownId)
        if (!dropdown) return

        dropdown.innerHTML = ""
        selectedIndex = -1

        if (cities.length === 0) {
          dropdown.style.display = "none"
          return
        }

        cities.forEach((city, index) => {
          const option = document.createElement("div")
          option.className =
            "px-4 py-2 hover:bg-blue-50 cursor-pointer text-gray-700 border-b border-gray-100 last:border-b-0"
          option.textContent = city
          option.onclick = () => selectCity(inputId, city)
          dropdown.appendChild(option)
        })

        dropdown.style.display = "block"
      }

      // éšè—åŸå¸‚ä¸‹æ‹‰åˆ—è¡¨
      function hideCityDropdown(inputId) {
        const dropdownId = inputId + "Dropdown"
        const dropdown = document.getElementById(dropdownId)
        if (dropdown) {
          dropdown.style.display = "none"
        }
        selectedIndex = -1
      }

      // é€‰æ‹©åŸå¸‚
      function selectCity(inputId, city) {
        const input = document.getElementById(inputId)
        if (input) {
          input.value = city
          hideCityDropdown(inputId)
          performCitySearch()
        }
      }

      // ç­›é€‰åŸå¸‚
      function filterCities(inputValue) {
        if (!inputValue) return Array.from(allCities).slice(0, 10)

        const filtered = Array.from(allCities).filter((city) =>
          city.toLowerCase().includes(inputValue.toLowerCase())
        )
        return filtered.slice(0, 10)
      }

      // å¤„ç†è¾“å…¥æ¡†ç„¦ç‚¹äº‹ä»¶
      function handleCityInputFocus(inputId) {
        currentFocusedInput = inputId
        const input = document.getElementById(inputId)
        if (input) {
          const cities = filterCities(input.value)
          showCityDropdown(inputId, cities)
        }
      }

      // å¤„ç†è¾“å…¥æ¡†å¤±ç„¦äº‹ä»¶
      function handleCityInputBlur(inputId) {
        // å»¶è¿Ÿéšè—ï¼Œå…è®¸ç‚¹å‡»ä¸‹æ‹‰é€‰é¡¹
        setTimeout(() => {
          if (currentFocusedInput === inputId) {
            hideCityDropdown(inputId)
            currentFocusedInput = null
          }
        }, 200)
      }

      // å¤„ç†è¾“å…¥æ¡†è¾“å…¥äº‹ä»¶
      function handleCityInputChange(inputId) {
        const input = document.getElementById(inputId)
        if (input) {
          const cities = filterCities(input.value)
          showCityDropdown(inputId, cities)
          performCitySearch()
        }
      }

      // å¤„ç†é”®ç›˜å¯¼èˆª
      function handleCityInputKeydown(event, inputId) {
        const dropdownId = inputId + "Dropdown"
        const dropdown = document.getElementById(dropdownId)
        if (!dropdown || dropdown.style.display === "none") return

        const options = dropdown.children
        if (options.length === 0) return

        switch (event.key) {
          case "ArrowDown":
            event.preventDefault()
            selectedIndex = Math.min(selectedIndex + 1, options.length - 1)
            updateSelectedOption(options)
            break
          case "ArrowUp":
            event.preventDefault()
            selectedIndex = Math.max(selectedIndex - 1, -1)
            updateSelectedOption(options)
            break
          case "Enter":
            event.preventDefault()
            if (selectedIndex >= 0 && selectedIndex < options.length) {
              const selectedCity = options[selectedIndex].textContent
              selectCity(inputId, selectedCity)
            }
            break
          case "Escape":
            hideCityDropdown(inputId)
            break
        }
      }

      // æ›´æ–°é€‰ä¸­çš„é€‰é¡¹æ ·å¼
      function updateSelectedOption(options) {
        Array.from(options).forEach((option, index) => {
          if (index === selectedIndex) {
            option.className =
              "px-4 py-2 bg-blue-100 cursor-pointer text-gray-700 border-b border-gray-100 last:border-b-0"
          } else {
            option.className =
              "px-4 py-2 hover:bg-blue-50 cursor-pointer text-gray-700 border-b border-gray-100 last:border-b-0"
          }
        })
      }

      // å¤‡ç”¨ç¤ºä¾‹æ•°æ®
      function getBackupFlightData() {
        return [
          {
            airline: "ä¸­å›½å›½é™…èˆªç©º",
            flight_number: "CA1234",
            departure: "åŒ—äº¬",
            destination: "ä¸Šæµ·",
            departure_province: "åŒ—äº¬å¸‚",
            destination_province: "ä¸Šæµ·å¸‚",
            departure_time: "08:30",
            arrival_time: "10:45",
            days: "1234567",
            product_type: "ç»æµèˆ±",
            is_night: false,
            segment: "å›½å†…"
          },
          {
            airline: "ä¸­å›½ä¸œæ–¹èˆªç©º",
            flight_number: "MU5678",
            departure: "ä¸Šæµ·",
            destination: "å¹¿å·",
            departure_province: "ä¸Šæµ·å¸‚",
            destination_province: "å¹¿ä¸œçœ",
            departure_time: "14:20",
            arrival_time: "17:10",
            days: "1234567",
            product_type: "å•†åŠ¡èˆ±",
            is_night: false,
            segment: "å›½å†…"
          },
          {
            airline: "ä¸­å›½å—æ–¹èˆªç©º",
            flight_number: "CZ9012",
            departure: "å¹¿å·",
            destination: "æ·±åœ³",
            departure_province: "å¹¿ä¸œçœ",
            destination_province: "å¹¿ä¸œçœ",
            departure_time: "22:15",
            arrival_time: "23:30",
            days: "1234567",
            product_type: "ç»æµèˆ±",
            is_night: true,
            segment: "å›½å†…"
          },
          {
            airline: "æµ·å—èˆªç©º",
            flight_number: "HU3456",
            departure: "æ·±åœ³",
            destination: "æˆéƒ½",
            departure_province: "å¹¿ä¸œçœ",
            destination_province: "å››å·çœ",
            departure_time: "06:45",
            arrival_time: "09:20",
            days: "1234567",
            product_type: "ç»æµèˆ±",
            is_night: false,
            segment: "å›½å†…"
          },
          {
            airline: "å¦é—¨èˆªç©º",
            flight_number: "MF7890",
            departure: "æˆéƒ½",
            destination: "è¥¿å®‰",
            departure_province: "å››å·çœ",
            destination_province: "é™•è¥¿çœ",
            departure_time: "01:30",
            arrival_time: "03:15",
            days: "1234567",
            product_type: "ç»æµèˆ±",
            is_night: true,
            segment: "å›½å†…"
          }
        ]
      }
    </script>
  </body>
</html>
